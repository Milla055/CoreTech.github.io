<app-header></app-header>

<div class="container">
  <!-- Profile Header -->
  <div class="profile-header">
    <div class="profile-avatar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
    </div>
    
    <div class="profile-info">
      <div class="profile-name-row">
        <h1 class="profile-name">{{ userData?.username || 'Felhasználó' }}</h1>
        <span class="admin-badge" *ngIf="isAdmin()">Admin</span>
      </div>
      <p class="profile-email">{{ userData?.email }}</p>
      
      <div class="profile-tabs">
        <button 
          class="tab-button" 
          (click)="logout()">
          Kijelentkezés
        </button>
        <button 
          *ngIf="isAdmin()"
          class="tab-button admin-button"
          (click)="goToAdminPage()">
          Adminbeállítások
        </button>
      </div>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Kedvencek -->
  <div class="favorites-section">
    <button class="favorites-button" (click)="openFavoritesModal()">
      Kedvencek 
      <span class="favorites-count" *ngIf="favorites.length > 0">({{ favorites.length }})</span>
    </button>
  </div>

  <!-- Kedvencek Modal -->
  <div class="modal-overlay" *ngIf="isFavoritesModalOpen" (click)="closeFavoritesModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Kedvenceim ({{ favorites.length }})</h2>
        <button class="modal-close-btn" (click)="closeFavoritesModal()">✕</button>
      </div>
      <div class="modal-body">
        <!-- Loading -->
        <div class="loading-favorites" *ngIf="loadingFavorites">
          <p>Kedvencek betöltése...</p>
        </div>
        
        <!-- Kedvencek lista -->
        <div class="favorites-list" *ngIf="!loadingFavorites && favorites.length > 0">
          <div class="favorite-card" *ngFor="let item of favorites">
            <div class="favorite-image">
              <img [src]="getProductImageUrl(item)" [alt]="item.name" />
            </div>
            <div class="favorite-info">
              <h3 class="favorite-name">{{ item.name }}</h3>
              <p class="favorite-category">{{ item.categoryName }} - {{ item.brandName }}</p>
              <div class="favorite-price-row">
                <span class="favorite-price">{{ formatPrice(item.pPrice) }}</span>
                <span class="favorite-old-price" *ngIf="item.price !== item.pPrice">{{ formatPrice(item.price) }}</span>
              </div>
              <div class="favorite-stock" [ngClass]="isInStock(item) ? 'in-stock' : 'out-of-stock'">
                {{ isInStock(item) ? '✓ Készleten (' + item.stock + ' db)' : '✗ Nincs készleten' }}
              </div>
            </div>
            <div class="favorite-actions">
              <button 
                class="add-to-cart-btn" 
                [disabled]="!isInStock(item)"
                (click)="addFavoriteToCart(item)"
                title="Kosárba">
                <img src="assets/icons8-shopping-cart-64.png" alt="cart" class="cartIcon">
              </button>
              <button 
                class="remove-favorite-btn" 
                (click)="removeFavorite(item.id)"
                title="Eltávolítás">
                <img src="assets/icons8-delete-trash-32.png" alt="remove" class="removeIcon">
              </button>
            </div>
          </div>
        </div>
        
        <!-- Üres állapot -->
        <div class="no-favorites" *ngIf="!loadingFavorites && favorites.length === 0">
          <p>Még nincs kedvenc terméked.</p>
          <p class="hint">Adj hozzá termékeket a kedvenceidhez a ♡ gombra kattintva!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Rendeléseim -->
  <div class="orders-section">
    <button class="orders-button" (click)="openOrdersModal()">Rendeléseim</button>
  </div>

  <!-- Rendeléseim Modal -->
  <div class="modal-overlay" *ngIf="isOrdersModalOpen" (click)="closeOrdersModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Rendeléseim</h2>
        <button class="modal-close-btn" (click)="closeOrdersModal()">✕</button>
      </div>
      <div class="modal-body">
        <div class="orders-list" *ngIf="orders.length > 0">
          <div class="order-card" *ngFor="let order of orders">
            <div class="order-header">
              <span class="order-id">#{{ order.id }}</span>
              <span class="order-status" [ngClass]="order.statusClass">{{ order.status }}</span>
            </div>
            <div class="order-date">{{ formatOrderDate(order.date) }}</div>
            <div class="order-items">
              <div class="order-item" *ngFor="let item of order.items">
                <span class="item-name">{{ item.name }}</span>
                <span class="item-quantity">x{{ item.quantity }}</span>
                <span class="item-price">{{ formatPrice(item.price) }}</span>
              </div>
            </div>
            <div class="order-total">
              <span>Összesen:</span>
              <span class="total-price">{{ formatPrice(order.total) }}</span>
            </div>
          </div>
        </div>
        <div class="no-orders" *ngIf="orders.length === 0">
          <p>Még nincs rendelésed.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Tabs -->
  <div class="tabs">
    <button 
      class="tab" 
      [class.active]="activeTab === 'fiokkezeles'" 
      (click)="setActiveTab('fiokkezeles')">
      Fiókkezelés
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'adatok'" 
      (click)="setActiveTab('adatok')">
      Adatok
    </button>
  </div>

  <!-- Tab Content: Fiókkezelés -->
  <div class="tab-content" *ngIf="activeTab === 'fiokkezeles'">
    <div class="content-section">
      <h3 class="section-title">Vásárlói adatok</h3>
      <form [formGroup]="customerDataForm">
        <div class="form-group">
          <label>Email cím</label>
          <input type="email" formControlName="email" placeholder="Email cím">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Vezetéknév</label>
            <input type="text" formControlName="vezetekNev" placeholder="Vezetéknév">
          </div>
          <div class="form-group">
            <label>Keresztnév</label>
            <input type="text" formControlName="keresztNev" placeholder="Keresztnév">
          </div>
        </div>
      </form>
    </div>

    <div class="content-section">
      <h3 class="section-title">Jelszó módosítása</h3>
      <form [formGroup]="passwordForm">
        <div class="form-group">
          <label>Régi jelszó</label>
          <div class="password-input-group">
            <input [type]="showOldPassword ? 'text' : 'password'" formControlName="regiJelszo" placeholder="Régi jelszó">
            <button type="button" class="password-toggle" (click)="togglePasswordVisibility('old')">
              <!-- Eye icon (show) -->
              <svg *ngIf="!showOldPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
              <!-- Eye-off icon (hide) -->
              <svg *ngIf="showOldPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Új jelszó</label>
          <div class="password-input-group">
            <input [type]="showNewPassword ? 'text' : 'password'" formControlName="ujJelszo" placeholder="Új jelszó (min. 8 karakter)">
            <button type="button" class="password-toggle" (click)="togglePasswordVisibility('new')">
              <!-- Eye icon (show) -->
              <svg *ngIf="!showNewPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
              <!-- Eye-off icon (hide) -->
              <svg *ngIf="showNewPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Új jelszó megerősítése</label>
          <div class="password-input-group">
            <input [type]="showConfirmPassword ? 'text' : 'password'" formControlName="ujJelszoMegerosites" placeholder="Jelszó megerősítése">
            <button type="button" class="password-toggle" (click)="togglePasswordVisibility('confirm')">
              <!-- Eye icon (show) -->
              <svg *ngIf="!showConfirmPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
              <!-- Eye-off icon (hide) -->
              <svg *ngIf="showConfirmPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-primary" (click)="onPasswordChange()" [disabled]="isChangingPassword">
            {{ isChangingPassword ? 'Mentés...' : 'Jelszó módosítása' }}
          </button>
        </div>
      </form>
    </div>

    <div class="content-section">
      <h3 class="section-title">Szállítási adatok</h3>
      <form [formGroup]="deliveryDataForm">
        <div class="form-row">
          <div class="form-group">
            <label>Ország</label>
            <input type="text" formControlName="orszag" placeholder="Magyarország">
          </div>
          <div class="form-group">
            <label>Irányítószám</label>
            <input type="text" formControlName="iranyitoszam" placeholder="1234">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Város</label>
            <input type="text" formControlName="varos" placeholder="Budapest">
          </div>
          <div class="form-group">
            <label>Utca, házszám</label>
            <input type="text" formControlName="utcaHazszam" placeholder="Fő utca 1.">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" formControlName="email" placeholder="email@example.com">
          </div>
          <div class="form-group">
            <label>Telefonszám</label>
            <input type="tel" formControlName="telefonszam" placeholder="+36 30 123 4567">
          </div>
        </div>
      </form>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" (click)="onSubmit()" [disabled]="isUpdatingProfile">
        {{ isUpdatingProfile ? 'Mentés...' : 'Változások mentése' }}
      </button>
      <button class="btn btn-secondary" (click)="resetChanges()">Visszaállítás</button>
    </div>
  </div>

  <!-- Tab Content: Adatok -->
  <div class="tab-content" *ngIf="activeTab === 'adatok'">
    <div class="content-section">
      <div class="data-row">
        <span class="data-label">Felhasználónév:</span>
        <span class="data-value">{{ userData?.username || '-' }}</span>
      </div>
      <div class="data-row">
        <span class="data-label">Email:</span>
        <span class="data-value">{{ userData?.email || '-' }}</span>
      </div>
      <div class="data-row">
        <span class="data-label">Teljes név:</span>
        <span class="data-value">{{ getFullName() }}</span>
      </div>
      <div class="data-row">
        <span class="data-label">Telefonszám:</span>
        <span class="data-value">{{ userData?.telefonszam || '-' }}</span>
      </div>
      <div class="data-row">
        <span class="data-label">Cím:</span>
        <span class="data-value">{{ getFullAddress() || '-' }}</span>
      </div>
      <div class="data-row">
        <span class="data-label">Szerepkör:</span>
        <span class="data-value">{{ userData?.role || 'Felhasználó' }}</span>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>