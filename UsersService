//createUser
public JSONObject createUser(String username, String email, String phone, String password, String role) {
    JSONObject resp = new JSONObject();
    EntityManager em = emf.createEntityManager();

    try {
        // Hash password
        String hashedPw = BCrypt.hashpw(password, BCrypt.gensalt(12));

        // Default role
        if (role == null || role.trim().isEmpty()) {
            role = "customer";
        }

        StoredProcedureQuery query = em.createStoredProcedureQuery("createUser");

        query.registerStoredProcedureParameter("usernIN", String.class, ParameterMode.IN);
        query.registerStoredProcedureParameter("emailIN", String.class, ParameterMode.IN);
        query.registerStoredProcedureParameter("phoneIN", String.class, ParameterMode.IN);
        query.registerStoredProcedureParameter("passwIN", String.class, ParameterMode.IN);
        query.registerStoredProcedureParameter("roleIN", String.class, ParameterMode.IN);

        query.setParameter("usernIN", username);
        query.setParameter("emailIN", email);
        query.setParameter("phoneIN", phone);
        query.setParameter("passwIN", hashedPw);
        query.setParameter("roleIN", role);

        em.getTransaction().begin();
        query.execute();
        em.getTransaction().commit();

        resp.put("status", "UserCreated");
        resp.put("statusCode", 201);

    } catch (Exception e) {
        resp.put("status", "DatabaseError");
        resp.put("statusCode", 500);
        e.printStackTrace();
    } finally {
        em.close();
    }

    return resp;
}
//softdel
public JSONObject softDeleteUser(int userId) {
        JSONObject resp = new JSONObject();
        EntityManager em = emf.createEntityManager();

        try {
            em.getTransaction().begin();

            StoredProcedureQuery spq = em.createStoredProcedureQuery("softdelUser");
            spq.registerStoredProcedureParameter("userIDIN", Integer.class, ParameterMode.IN);
            spq.setParameter("userIDIN", userId);

            spq.execute();

            em.getTransaction().commit();

            resp.put("status", "UserSoftDeleted");
            resp.put("statusCode", 200);

        } catch (Exception e) {
            e.printStackTrace();
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            resp.put("status", "DatabaseError");
            resp.put("statusCode", 500);

        } finally {
            em.close();
        }

        return resp;
    }

//updateUser

public JSONObject updateUser(int userId, String email, String phone) {
        JSONObject resp = new JSONObject();
        EntityManager em = emf.createEntityManager();

        try {
            em.getTransaction().begin();

            StoredProcedureQuery spq = em.createStoredProcedureQuery("updateUser");

            spq.registerStoredProcedureParameter("userIdIN", Integer.class, ParameterMode.IN);
            spq.registerStoredProcedureParameter("emailIN", String.class, ParameterMode.IN);
            spq.registerStoredProcedureParameter("phoneIN", String.class, ParameterMode.IN);

            spq.setParameter("userIdIN", userId);
            spq.setParameter("emailIN", email);
            spq.setParameter("phoneIN", phone);

            spq.execute();

            em.getTransaction().commit();

            resp.put("status", "UserUpdated");
            resp.put("statusCode", 200);

        } catch (Exception e) {
            e.printStackTrace();
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            resp.put("status", "DatabaseError");
            resp.put("statusCode", 500);
        } finally {
            em.close();
        }

        return resp;
    }

//updatePassword
public JSONObject updatePassword(int userId, String newPassword) {
        JSONObject resp = new JSONObject();
        EntityManager em = emf.createEntityManager();

        try {
            // hash password
            String hashed = BCrypt.hashpw(newPassword, BCrypt.gensalt(12));

            em.getTransaction().begin();

            StoredProcedureQuery spq = em.createStoredProcedureQuery("updatePassword");

            spq.registerStoredProcedureParameter("passwordIN", String.class, ParameterMode.IN);
            spq.registerStoredProcedureParameter("userIdIN", Integer.class, ParameterMode.IN);

            spq.setParameter("passwordIN", hashed);
            spq.setParameter("userIdIN", userId);

            spq.execute();

            em.getTransaction().commit();

            resp.put("status", "PasswordUpdated");
            resp.put("statusCode", 200);

        } catch (Exception e) {
            e.printStackTrace();
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            resp.put("status", "DatabaseError");
            resp.put("statusCode", 500);
        } finally {
            em.close();
        }

        return resp;
    }
//getordersbyuserid
public JSONObject getOrdersByUserId(int userId) {
        JSONObject resp = new JSONObject();
        EntityManager em = emf.createEntityManager();

        try {
            StoredProcedureQuery spq = em.createStoredProcedureQuery("getOrdersByUserId");

            spq.registerStoredProcedureParameter("userIdIN", Integer.class, ParameterMode.IN);
            spq.setParameter("userIdIN", userId);

            List<Object[]> rows = spq.getResultList();
            JSONArray arr = new JSONArray();

            for (Object[] row : rows) {
                JSONObject obj = new JSONObject();

                obj.put("orderId", row[0]);
                obj.put("productName", row[1]);
                obj.put("imageUrl", row[2]);
                obj.put("totalPrice", row[3]);
                obj.put("status", row[4]);
                obj.put("quantity", row[5]);
                obj.put("createdAt", row[6]);

                arr.put(obj);
            }

            resp.put("orders", arr);
            resp.put("status", "Success");
            resp.put("statusCode", 200);

        } catch (Exception e) {
            e.printStackTrace();
            resp.put("status", "DatabaseError");
            resp.put("statusCode", 500);
        } finally {
            em.close();
        }

        return resp;
    }
//login
public JSONObject login(String email, String password) {
        JSONObject resp = new JSONObject();
        EntityManager em = emf.createEntityManager();

        try {
            StoredProcedureQuery spq = em.createStoredProcedureQuery("login");

            spq.registerStoredProcedureParameter("emailIN", String.class, ParameterMode.IN);
            spq.setParameter("emailIN", email);

            try {
                spq.execute();
            } catch (Exception ex) {
                ex.printStackTrace();
                resp.put("status", "DatabaseError");
                resp.put("statusCode", 500);
                return resp;
            }

            
            List<Object> rows = spq.getResultList();

            // nincs találat
            if (rows == null || rows.isEmpty()) {
                resp.put("status", "InvalidEmailOrPassword");
                resp.put("statusCode", 401);
                return resp;
            }

            // HASH lekérése (EGY darab string)
            String storedHash = rows.get(0).toString();

            // bcrypt ellenőrzés
            try {
                if (!BCrypt.checkpw(password, storedHash)) {
                    resp.put("status", "InvalidEmailOrPassword");
                    resp.put("statusCode", 401);
                    return resp;
                }
            } catch (Exception e) {
                resp.put("status", "InvalidEmailOrPassword");
                resp.put("statusCode", 401);
                return resp;
            }

            // itt minden ok
            resp.put("status", "LoginSuccess");
            resp.put("statusCode", 200);

        } catch (Exception e) {
            e.printStackTrace();
            resp.put("status", "DatabaseError");
            resp.put("statusCode", 500);

        } finally {
            em.close();
        }

        return resp;
    }

//login +jwt 
public JSONObject login(String email, String password) {
        JSONObject resp = new JSONObject();
        EntityManager em = emf.createEntityManager();

        try {
            StoredProcedureQuery spq = em.createStoredProcedureQuery("login");

            spq.registerStoredProcedureParameter("emailIN", String.class, ParameterMode.IN);
            spq.setParameter("emailIN", email);

            spq.execute();

            List<Object> rows = spq.getResultList();

            if (rows == null || rows.isEmpty()) {
                resp.put("status", "InvalidEmailOrPassword");
                resp.put("statusCode", 401);
                return resp;
            }

            String storedHash = rows.get(0).toString();

            if (!BCrypt.checkpw(password, storedHash)) {
                resp.put("status", "InvalidEmailOrPassword");
                resp.put("statusCode", 401);
                return resp;
            }

            //token
            String token = JwtUtil.generateToken(email);

            resp.put("status", "LoginSuccess");
            resp.put("statusCode", 200);
            resp.put("token", token);  

        } catch (Exception e) {
            e.printStackTrace();
            resp.put("status", "DatabaseError");
            resp.put("statusCode", 500);

        } finally {
            em.close();
        }

        return resp;
    }

