public JSONObject createUser(Users createdUser, String confirmPassword) {
        JSONObject toReturn = new JSONObject();
        String status = "success";
        int statusCode = 200;

        // Validáció: minden kötelező mező
        if (createdUser.getUsername() == null || createdUser.getUsername().trim().isEmpty()
                || createdUser.getEmail() == null || createdUser.getEmail().trim().isEmpty()
                || createdUser.getPhone() == null || createdUser.getPhone().trim().isEmpty()
                || createdUser.getPasswordHash() == null || createdUser.getPasswordHash().trim().isEmpty()) {

            status = "MissingRequiredField";
            statusCode = 400;
            toReturn.put("status", status);
            toReturn.put("statusCode", statusCode);
            return toReturn;
        }

        // Jelszó egyeztetés
        if (!createdUser.getPasswordHash().equals(confirmPassword)) {
            status = "PasswordsDoNotMatch";
            statusCode = 400;
            toReturn.put("status", status);
            toReturn.put("statusCode", statusCode);
            return toReturn;
        }

        EntityManager em = emf.createEntityManager();
        try {
            // Ellenőrzés: email már létezik?
            TypedQuery<Users> query = em.createQuery(
                    "SELECT u FROM Users u WHERE u.email = :email AND u.isDeleted = false", Users.class
            );

            query.setParameter("email", createdUser.getEmail());
            List<Users> existing = query.getResultList();
            if (!existing.isEmpty()) {
                status = "EmailTaken";
                statusCode = 409;
                toReturn.put("status", status);
                toReturn.put("statusCode", statusCode);
                return toReturn;
            }

            // DB insert
            em.getTransaction().begin();
            em.persist(createdUser);
            em.getTransaction().commit();

            JSONObject result = new JSONObject();
            result.put("username", createdUser.getUsername());
            result.put("email", createdUser.getEmail());
            result.put("phone", createdUser.getPhone());
            result.put("role", createdUser.getRole());

            toReturn.put("result", result);

        } catch (Exception ex) {
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            ex.printStackTrace();
            status = "DatabaseError";
            statusCode = 500;

        } finally {
            em.close();
        }

        toReturn.put("status", status);
        toReturn.put("statusCode", statusCode);
        return toReturn;
    }
